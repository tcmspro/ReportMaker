<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Report Tool</title>
<style>
    /* Style the main container with rounded corners */
    .form-container {
        border: 2px solid #4CAF50; /* Green border */
        border-radius: 15px;      /* Rounded corners */
        padding: 20px;
        width: 330px;
        margin: 20px auto;
        background-color: #f9f9f9;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* Style the input fields */        
    .form-container input[type=text],
    .form-container input[type=number],
    .form-container input[type=date] {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px; /* Slightly rounded inputs */
        box-sizing: border-box; /* Important for padding */
    }

.form-hdg   {   text-align: center; margin-top: 0;}

.form-row {  display: flex;  align-items: center;  margin-bottom: 12px;  position: relative;    }
.form-row label {  width: 120px;  font-size: 15px; font-weight: bold; }
.form-row input,
.form-row select {  flex: 1;  padding: 6px;  font-size: 14px; border: 1px solid #ccc; border-radius: 4px;   box-sizing: border-box; }

    /* Style the submit button */
    .form-container input[type=submit] {
        width: 100%;
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        margin: 10px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }

    .form-container input[type=submit]:hover {
        background-color: #45a049;
    }

    .fieldsets {  display: flex;  gap: 12px;  margin-bottom: 14px;  }
    fieldset {  flex: 1;  border: 1px solid #cbd5e1;  border-radius: 4px;  padding: 8px;    }
    legend {  font-size: 13px;  font-weight: bold;  }

    .radio-group {  display: flex;  gap: 14px;  }

    .same-width {
        width: 330px; /* Set your desired width */
        box-sizing: border-box; /* Includes padding/border in width */
        padding: 8px; /* Optional: same padding for both */
        border: 1px solid #ccc; /* Optional: same border for both */
      }

    /* ---------- Autocomplete ---------- */
    .autocomplete-box {
      position: absolute;
      top: 100%;
      left: 120px;
      right: 0;
      background: #fff;
      border: 1px solid #cbd5e1;
      max-height: 160px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
    .autocomplete-item {  padding: 8px;  cursor: pointer;   }
    .autocomplete-item.active,
    .autocomplete-item:hover {  background: #e2e8f0;    }
    .autocomplete-item strong {  color: #0ea5e9;    }

/* ---------- Buttons ---------- */
.actions {  display: flex;  gap: 10px;}
.submit-btn {  flex: 1;  padding: 10px;  background: #16a34a;  color: #fff;  border: none;  border-radius: 4px; }
.secondary-btn {  flex: 1;  padding: 10px;  background: #0ea5e9;  color: #fff;  border: none;  border-radius: 4px;  }


.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:16px;border-radius:6px;width:300px}
.msg-box{line-height:1.6}

/* Buttons */
.btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
}

.btn-edit {
  background: #2563eb; /* blue */
  color: #fff;
  /*border:none;padding:8px*/
}

.btn-save {
  background: #16a34a; /* green */
  color: #fff;
  /*border:none;padding:8px*/
}

.btn-cancel {
  background: #dc2626; /* red */
  color: #fff;
  /*border:none;padding:8px*/
}

.btn-close {
  background: #2563eb; /* blue */
  color: #fff;
  /*border:none;padding:8px*/
}


/* Modal overlay */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* Modal box */
.modal-box {
  width: 100%;
  max-width: 300px;
  background: #fff;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
}

/* Caption bar */
.modal-header {
  background: #0ea5e9; /* blue */
  color: #fff;
  padding: 12px;
  font-weight: bold;
  text-align: center;
  font-size: 15px;
}

/* Modal body */
.modal-body {  padding: 16px;  font-size: 14px;  line-height: 1.6;  overflow-y: auto;}

/* Modal footer */
.modal-footer {  display: flex;  gap: 10px;  padding: 12px;    }

/* Reply */
.editableMessage1 {  overflow-y: auto;                                         
                    overflow-x: hidden;/* Optional: Hide horizontal scrollbar if it appears unexpectedly */
                 }

#editableMessage {
  max-height: 220px;          
  overflow-y: auto;
  padding: 10px;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  background: #fff;
  line-height: 1.5;
}

/* Desktop enhancement */
@media (min-width: 768px) {
    .app-container {
        max-width: 520px;  /* Slightly wider on desktop */
    }
    .modal-box {    max-width: 380px;   }
}

</style>
</head>
<body>
<div class="form-container">
    <h3 class="form-hdg">Trading Report Tool</h3>
    <form id="callForm">
        <div class="fieldsets">
          <fieldset>
            <legend>Option Type</legend>
            <div class="radio-group">
              <label><input type="radio" name="optiontype" value="CE" checked> CE</label>
              <label><input type="radio" name="optiontype" value="PE"> PE</label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Expiry</legend>
            <div class="radio-group">
              <label><input type="radio" name="expirytype" value="JAN" checked> JAN</label>
              <label><input type="radio" name="expirytype" value="FEB"> FEB</label>
            </div>
          </fieldset>
        </div>


    <div class="form-row">
      <label>Date</label>  <input type="date" id="callDate"> 
    </div>
    <div class="form-row">
      <label>CF-Date</label>  <input type="date" id="cfDate"> 
    </div>
    <div class="form-row"><label>Trade</label>
        <select id="tradetype"><option>Buy<selected></option><option>Sell</option></select>
    </div>
    <div class="form-row">
      <label>Script</label>
      <input type="text" id="script" autocomplete="off">
      <div id="autocompleteBox" class="autocomplete-box"></div>
    </div>
    <div class="form-row"><label>Expiry</label>
        <select id="wklyexpiry"></select>
    </div>
    <div class="form-row"><label>Strike</label><input id="strike" type="number"></div>
    <div class="form-row"><label>From</label><input type="number" id="from" step="0.01"></div>
    <div class="form-row"><label>To</label><input type="number" id="to" step="0.01"></div>

    <div class="actions">
      <button class="submit-btn">Submit</button>
      <button type="button" class="secondary-btn" onclick="showMsg();">Show Message</button>
    </div>

    </form>
</div>


<div class="modal" id="msgModal">
  <div class="modal-box">    
    <div class="modal-header">
      <span>Report Message For Telegram</span>      
    </div>
    <div class="modalfieldsets">
      <fieldset>
        <legend>Choose Market</legend>
        <div class="radio-group">
          <label><input type="radio" name="markettype" value="INDIAN" checked> INDIAN</label>
          <label><input type="radio" name="markettype" value="FOREX"> FOREX</label>
        </div>
      </fieldset>
    </div>
    <div class="modal-body" id="msgBox">
      <div
        id="editableMessage"
        class="rich-box readonly"
        contenteditable="false">
      </div>    
    </div>
    <div class="modal-footer">
      <!--<button id="editMsgBtn" class="btn btn-edit" onclick="toggleEditMessage()">Edit</button>
      <button class="btn btn-close" onclick="closeModal('msgModal')">Close</button>
      
      <button class="btn btn-edit" onclick="enableEdit()">Edit</button>
      <button class="btn btn-save" onclick="saveEditedMessage()">Save</button>
      <button class="btn btn-close" onclick="closeModal('msgModal')">Close</button>
      
      <button class="btn btn-edit" >Edit</button>
      -->
      <button class="btn btn-save" onclick="saveEditedMessage()">Copy</button>
      <button class="btn btn-close" onclick="closeModal('msgModal')">Close</button>
    </div>

  </div>
</div>

<script>

let calls=[], replyList=[], selected=null;
let stockList = [];
let expiryList = [];


callDate.value = new Date().toISOString().split("T")[0];
cfDate.value = new Date().toISOString().split("T")[0];

function loadExpiryJson(){
  //let stockData = [];

fetch('./data/ExpiryList.json')
  .then(response => response.json())
  .then(json => {
    // Access the 'stockData' key from the parsed JSON object
    //stockData = json.stockData; 
    expiryList = json.indexExpiry;
    
    // Now you can access it as requested
    //console.log(stockData[0].value); // "BankNifty"
    //console.log("Symbol - ",stockList[0].value, " Lot Size - ",stockList[0].lotsize); // "BankNifty"
  })
  .catch(error => console.error('Error:', error));
}


function loadScriptsJson() {
  /* ---------- Load Stock List ---------- */
  let stockData = [];
  /*fetch("./data/StockLists.json")
    .then(r => r.json())
    .then(d => stockList = d.stockData.map(s => s.value))
    .catch(() => alert("Failed to load StockLists.json"));
*/
fetch("./data/StockLists.json")
  .then(res => res.json())
  .then(data => {
    stockList = data.stockData.map(item => {
                // Return a new object with only the required properties
                return {
                  value: item.value,
                  lotsize: item.lotsize
                }; // IMPORTANT
            });
            })
  .catch(err => console.error("StockList load error", err));

  //console.log(stockList);
  /* ---------- Autocomplete --------- */
  const input = document.getElementById("script");
  const box = document.getElementById("autocompleteBox");
  let index = -1;


  input.addEventListener("input", () => {
    const val = input.value.toLowerCase();
    box.innerHTML = "";
    index = -1;

    if (!val) return box.style.display = "none";

    const matches = stockList.filter(s => s.value.toLowerCase().startsWith(val));
    if (!matches.length) return box.style.display = "none";

    matches.forEach((s, i) => {
      const div = document.createElement("div");
      div.className = "autocomplete-item";
      div.innerHTML = "<strong>" + s.value.substr(0,val.length) + "</strong>" + s.value.substr(val.length);
      div.onclick = () => { input.value = s.value; box.style.display = "none"; };
      box.appendChild(div);
    });

    box.style.display = "block";
  });

  input.addEventListener("keydown", e => {
    const items = box.querySelectorAll(".autocomplete-item");
    if (!items.length) return;

    if (e.key === "ArrowDown") { index = (index + 1) % items.length; }
    if (e.key === "ArrowUp") { index = (index - 1 + items.length) % items.length; }
    if (e.key === "Escape") { ResetInputs();    input.value = "";  }
    if (e.key === "Enter") {
      e.preventDefault();
      if (index >= 0) items[index].click();

      /* Dont Update Expiries for Forex or non-Index Symbols */
      let selName = items[index].innerHTML;
      if(chkForexSymbol(selName) === false){     
        if(chkIndexSymbol(selName) === false){         ResetInputs();     updateExpiries();   }      }
    }

    items.forEach(i => i.classList.remove("active"));
    if (index >= 0) items[index].classList.add("active");
  });

  document.addEventListener("click", e => {
    //console.log(input.value);
    if (!input.contains(e.target)) {  
        
        /* Dont Update Expiries for Foex Symbols */
        let selName = input.value;
        if(chkForexSymbol(selName) === false){     
            if(chkIndexSymbol(selName) === false){      ResetInputs();     updateExpiries();   }
        }

        box.style.display = "none";   //updateExpiries();   
        }
  });
  
}

//let selName = items[index].innerHTML; if(chkForexSymbol(selName) === false){     ResetInputs(txtName);    } 

function chkIndexSymbol(txtSymbol)
{
    let text = txtSymbol; 
    const selectedSymbol = text.replace(/<\/?[^>]+(>|$)/g, "");

    const expirySelect = document.getElementById('wklyexpiry');
    const strikeInput = document.getElementById('strike');
    
    const indexValues = ["Nifty", "Sensex"];

    /*For non-Index Symbols No Expiry Selection & StrikePrice */
    if(!indexValues.includes(selectedSymbol.trim())) {   
                
        //Blank if any previous values
        expirySelect.innerHTML = "";
        //strikeInput.value="";

        // Set the disabled property
        expirySelect.disabled = true;
        //strikeInput.disabled = true; 

        return true;
    };

    return false;
}

function chkForexSymbol(txtSymbol)
{
    let text = txtSymbol; 
    const selectedSymbol = text.replace(/<\/?[^>]+(>|$)/g, "");

    const expirySelect = document.getElementById('wklyexpiry');
    const strikeInput = document.getElementById('strike');
    
    const forexValues = ["XAUUSD", "BTCUSD"];

    /*For Forex Symbols No Expiry Selection & StrikePrice */
    if(forexValues.includes(selectedSymbol.trim())) {   
                
        //Blank if any previous values
        expirySelect.innerHTML = "";
        strikeInput.value="";

        // Set the disabled property
        expirySelect.disabled = true;
        strikeInput.disabled = true; 

        return true;
    };

    return false;
}

function formatDate(timestamp) {
  const dateObj = new Date(timestamp);

  // Get day, month, and year components
  let day = dateObj.getDate();
  let month = dateObj.getMonth() + 1; // Month is 0-indexed, so add 1
  let year = dateObj.getFullYear();

  // Pad day and month with a leading zero if they are single digits
  day = day < 10 ? '0' + day : day;
  month = month < 10 ? '0' + month : month;

  // Assemble the date string in "dd-MM-yyyy" format
  return `${day}-${month}-${year}`;
}

function formatDateTime(timestamp,isexpiry) {
    // Create a new Date object from the numeric timestamp
    const dateObj = new Date(timestamp);
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
   //console.log(timestamp);
    // Get individual components
    const day = String(dateObj.getDate()).padStart(2, '0');
    const month = months[dateObj.getMonth()]; // getMonth() is 0-indexed (Jan is 0)
    //const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Months are 0-based
    const year = dateObj.getFullYear();
    const hours = String(dateObj.getHours()).padStart(2, '0');
    const minutes = String(dateObj.getMinutes()).padStart(2, '0');
    const seconds = String(dateObj.getSeconds()).padStart(2, '0');

    if(isexpiry === true) {   return `${day} ${month}`;   }

    // Assemble the parts into the desired format
    return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
}

// Helper to convert "dd/mm/yyyy" to a Date object
function parseDate(dateStr) {
    const [day, month, year] = dateStr.split('/');
    return new Date(year, month - 1, day); // Month is 0-indexed
}

function fromDDMM_MMDD_DateFormat(datestr){
  const original = datestr; //'13/01/2026';
  const [day, month, year] = original.split('/');
  const mdy = `${month}/${day}/${year}`;

  return mdy;
}

/* For Date Format like "5th Jan 2026" */
function HeadingDateFormat(hdgDate){

    const headgDate = new Date(hdgDate);
    const day = headgDate.getDate();
    const formatter = new Intl.DateTimeFormat('en-US', { month: 'short', year: 'numeric' });
    const monthYear = formatter.format(headgDate); // "Jan 2026"

    const ordinalDay = day + (['st','nd','rd'][((day+90)%100-10)%10-1] || 'th');
    //console.log(`${ordinalDay} ${monthYear}`); // "5th Jan 2026"

    return `${ordinalDay} ${monthYear}`;
}

function updateExpiries() {
    const symbolSelect = document.getElementById('script');    
    const expirySelect = document.getElementById('wklyexpiry');
    //const strikeInput = document.getElementById('strike');

    const selectedSymbol = symbolSelect.value;
    
    /*const forexValues = ["XAUUSD", "BTCUSD"];*/

    /*For Forex Symbols No Expiry Selection & StrikePrice */
/*    if(forexValues.includes(selectedSymbol.trim())) {   
        const shouldDisable = (this.value === 'inactive');
    
        // Set the disabled property
        expirySelect.disabled = shouldDisable;
        strikeInput.disabled = shouldDisable;

        return;
    };
*/
    // Clear previous options
    expirySelect.innerHTML = '<option value="">-- Choose Expiry --</option>';
    
    if (!selectedSymbol) return;

    // Get today's date (at midnight for accurate comparison)
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Filter by symbol AND date >= today
    const filteredExpiries = expiryList.filter(item => {
        const itemDate = parseDate(item.expiry);
        return item.value === selectedSymbol && itemDate >= today;
    });

    // Sort to ensure chronological order (optional but recommended)
    filteredExpiries.sort((a, b) => parseDate(a.expiry) - parseDate(b.expiry));

    // Fill the select input
    filteredExpiries.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = item.expiry;
        option.textContent = item.expiry;
        expirySelect.appendChild(option);
    });

    //console.log("Expiries - ",filteredExpiries);
    // Automatically select the 1st valid expiry if available
    if (filteredExpiries.length > 0) {
        expirySelect.selectedIndex = 1; // 0 is the placeholder
    }
}


callForm.onsubmit=e=>{
e.preventDefault();

let f=+from.value,t=+to.value;


//if(!(f<t&&slv<f&&t1v>t&&t2v>t1v&&t3v>t2v)) return alert("Validation failed");

//calls.push({id:Date.now(),script:script.value,from:f,to:t,t1:t1v,t2:t2v,t3:t3v,status:"Inactive"});
const symbolname = callForm.script.value;
const lsz = stockList.find(s => s.value === symbolname)?.lotsize;

const indexValues = ["Nifty","Sensex"];
const forexValues = ["XAUUSD", "BTCUSD"];

const cexpiry = (indexValues.includes(symbolname.trim())) ? callForm.wklyexpiry.value : callForm.expirytype.value;
//const callexpiry = new Date(cexpiry.split('/').reverse().join('-')); // "2026-01-13"
const callexpiry = new Date(fromDDMM_MMDD_DateFormat(cexpiry));
if(callexpiry === "Invalid Date")
{
    callexpiry = cexpiry;
}


//console.log(symbolname, callForm.wklyexpiry.value, callForm.expiry.value);
//+opttype1, + epx1, +date, +script, +strike
//console.log(cfDate.value);
const callObj = {
        id: Date.now(),
        date: callForm.callDate.value,
        cfdate: callForm.cfDate.value,  //cfDate means CarryForward Date of the Call which was given on a previous Date
        tradetype: callForm.tradetype.value,
        script: callForm.script.value,
        expiry: callexpiry,
        strike: callForm.strike.value,
        option: callForm.optiontype.value,
        from: f,      to: t,     
        lotSize: lsz,
        tg_msgid: null   // Telegram message id of NEW CALL
    };

    calls.push(callObj);

//sendNewCallToTelegram(callObj);
//console.log(callObj);
//render();

/* If Current Symbol is a Forex Symbol then Reset the Inputs to "Enable" */
if(forexValues.includes(symbolname.trim())){     ResetInputs();    }

callForm.reset();
callDate.value = new Date().toISOString().split("T")[0];
cfDate.value = new Date().toISOString().split("T")[0];

// Clear the expiry dropdown
const expirySelect = document.getElementById('wklyexpiry');
expirySelect.options.length = 0; // Keep only "-- Choose Expiry --"


};

function ResetInputs()
{
    const expirySelect = document.getElementById('wklyexpiry');
    const strikeInput = document.getElementById('strike');

    //console.log("called");
    expirySelect.disabled = false;
    strikeInput.disabled = false;    
}

function showMsg()
{
  let reportMessage = "";
  reportMessage = generateReportShow(calls);
  //reportMessage = generateReportCopy(calls); //generateReportShow(calls);
  editableMessage.innerHTML = reportMessage;

  msgModal.style.display='flex';
}

function generateReportShow(trades) {
    //const selMarket = getRadioValue("markettype");  // FOREX / INDIAN;
    let totalPips = 0;
    let totalProfit01 = 0;
    let totalProfit1 = 0;
    let reportBody = ""; 
    //console.log(trades);

    const forexSymbols = ["XAUUSD", "BTCUSD"];

    //const mktType = document.querySelector('input[name="optiontype"]:checked')?.value || "";

    //console.log(trades);
    const marketTrades = trades.filter(trade => {
      const isForexSymbol = forexSymbols.includes(trade.script);

      if (reportIndianMarket === false) {
        // Only include if it's one of the two forex symbols
        return isForexSymbol;
      } else {
        // Indian market: include everything EXCEPT those two symbols
        return !isForexSymbol;
      }
    });

    //console.log(marketTrades);

    if (reportIndianMarket === false) 
    {
      reportBody = `<b>Trades Summary - ${HeadingDateFormat(new Date())}</b><br><br>`;

      marketTrades.forEach((trade, index) => {
          let pips = 0;
          let profit01 = 0;
          let profit1 = 0;
          //console.log(trade);
          const isBuy = trade.tradetype.toLowerCase() === "buy";
          const diff = isBuy ? (trade.to - trade.from) : (trade.from - trade.to);

          if (trade.script === "XAUUSD") {
              // Gold: 1 pip = 0.01 move. 100 pips = $1 move.
              pips = diff * 100; 
              profit1 = diff * 100; // $100 per $1 move for 1 lot
              profit01 = diff * 10;  // $10 per $1 move for 0.1 lot
          } else if (trade.script.includes("BTCUSD")) {
              // Crypto: Generally 1 point move = 1 pip
              pips = diff;
              profit1 = diff * 1; 
              profit01 = diff * 0.1;
          } else {
              // Forex: 1 pip = 0.0001 move
              pips = diff * 10000;
              profit1 = pips * 10;
              profit01 = pips * 1;
          }

          totalPips += pips;
          totalProfit01 += profit01;
          totalProfit1 += profit1;

          const suffix = (index + 1 === 1) ? "st" : (index + 1 === 2) ? "nd" : (index + 1 === 3) ? "rd" : "th";

          //reportBody += `<b>${index + 1}${suffix} ${toEmojiNumber(index + 1)} Trade</b><br>`;
          reportBody += `<b>${toEmojiNumber(index + 1)} Trade</b><br>`;
          reportBody += `<b>${trade.tradetype} ${trade.script} ${trade.from} ‚ûù ${trade.to}</b><br>`;
          reportBody += `üìå <b>Total Pips: ${pips.toFixed(1)}</b><br>`;
          reportBody += `üíµ <b>Profit(0.10 Lot): $${profit01.toFixed(2)} üíµ</b><br>`;
          reportBody += `üí∞ <b>Profit(1 Lot): $${profit1.toFixed(2)} üíµ<br></b><br>`;
      });


      reportBody += `‚û°Ô∏è‚û°Ô∏è <b>Final Result (Day Summary)</b><br>`;
      reportBody += `‚û°Ô∏è‚û°Ô∏è <b>Total Pips: ${totalPips.toFixed(1)}</b><br>`;
      reportBody += `üí≤ <b>Profit for 0.10 Lot: $${totalProfit01.toFixed(2)}</b>üí≤<br>`;
      reportBody += `üí≤ <b>Profit for 1 Lot: $${totalProfit1.toFixed(2)}</b></b><br><br>`;

      reportBody += `üî•üî•<b>Strong Start to December ‚Äî Consistent Profits!</b><br>`;
      reportBody += `üîó <b>Join us & grow your account daily!üí∞üöÄ</b><br>`;

    }
    else{
      reportBody = `üí•üöÄüí•üöÄ<b> Index Options (${HeadingDateFormat(new Date())}) Watchout Today's Super Awesome Premium Channel Performance. </b><br><br>`;
      reportBody += `<b>Trade Summary</b> üëáüëáüëáüëáüëá<br><br>`;
      
      marketTrades.forEach((trade, index) => {
          let pips = 0;
          let pnLPoints = 0;
          let profit01 = 0;
          let profit1 = 0;
          let totLots = 2;
          let tradeNote = "";
          let prevCallDate = "";

          //console.log(trade);
          const isBuy = trade.tradetype.toLowerCase() === "buy";
          //const diff = isBuy ? (trade.to - trade.from) : (trade.from - trade.to);
          const diff = trade.to - trade.from;
          //console.log(trade);
          pips = diff ; 
          pnLPoints = diff;
          profit01 = diff * trade.lotSize * totLots; 

          // Filter items For LotSize using "Symbol"
/*const matches = stockList.filter(item => 
  item.value.toLowerCase() === "");*/

          //console.log(" Points -",pips, " LotSize - ", trade.lotSize," Profit - ", profit01);
          const entryPrice = trade.from;

          if (pnLPoints > entryPrice) {
              tradeNote = "üí•üí• Price Doubled N More üí•üí•"; // Case: 15 points profit on 10 entry
          } else if (pnLPoints === entryPrice) {
              tradeNote = "üí• Price Doubled üí•";        // Case: 10 points profit on 10 entry
          } else if (pnLPoints >= entryPrice * 0.9) {
              tradeNote = "Price Nearly Doubled"; // Case: 9 points (90%) profit on 10 entry
          }

          totalPips += pips;
          totalProfit01 += profit01;
          let pnlEmoji = "";

          /*if(pnLPoints>0){ pnlEmoji = " ü§ë "}
          else{ pnlEmoji =" üòî "}*/


          //First Check Whether the Symbol is Nifty/Sensex & whether its expiry is Weekly if not then select the last Expiry of the Month
          //i.e. the Radio Button value
          let dtExpiry = "";
          
          if( new Date(trade.expiry).toString()  === "Invalid Date")
            {         dtExpiry = "(" + getRadioValue("expirytype") + ")";
            }
          else {      dtExpiry = formatDateTime(trade.expiry,true);   }

          //console.log(dtExpiry);
          
          const suffix = (index + 1 === 1) ? "st" : (index + 1 === 2) ? "nd" : (index + 1 === 3) ? "rd" : "th";
          //console.log(profit01);


          if (new Date(trade.date).toDateString() != new Date(trade.cfdate).toDateString()) {
              prevCallDate = "call given on (" + formatDateTime(trade.cfdate,true) + ")";
          }
          //console.log("prevCallDate", prevCallDate, " Date - ",trade.date, " CfDate - ",trade.cfdate);

          if(pnLPoints>0){
            //reportBody += `<b>${index + 1}${suffix} ${toEmojiNumber(index + 1)} Trade</b><br>`;
            reportBody += `‚û°Ô∏è<b>${trade.tradetype} ${trade.script} ${dtExpiry} ${trade.strike} ${trade.option} ${prevCallDate} - ${tradeNote}</b><br>`;
            reportBody += `<b>${trade.from} ‚ûù ${trade.to} = ${pips.toFixed(2)} Plus Points </b>ü§ë<br>`;
            reportBody += `<b>Total Points: ${pips.toFixed(1)}</b><br>`;
            reportBody += `<b>Maximum Profits: Rs. ${profit01.toFixed(2)}/- For 2 Lots  ‚ûï‚ûï</b><br><br>`;
          }
          else{
            reportBody += `‚û°Ô∏è<b>${trade.tradetype} ${trade.script} ${dtExpiry} ${trade.strike} ${trade.option} - <br>`;
            reportBody += `${trade.from} ‚ûù ${trade.to} = ${pips.toFixed(2)} Points Loss</b>üòî<br><br>`;
          }
  
      });


    reportBody += `<b>Amazing Accuracy & Amazing Jackpot Profits By Premium Members</b> ü§ëü§ë<br><br>`;
    reportBody += `<b>Nearly All Trades <br>Perfect Selection Of Entry Levels - </b><br><b>Perfect Movement Caught - </b><br><b>Perfect Target üéØ üéØ Achieved üòéüòé</b><br><br>`;
    reportBody += `<b>Don't Miss To Join Stock Market School (sms) Premium Channel For Consistent Profits. üí≤üí≤</b><br><br>`;
    reportBody += `<b>Link To Join Our Premium Subscription Is Pinned </b><br>`;
    reportBody += `<b>@ Top In This Channel </b><br><br>`;
    reportBody += `<b>üíöüíö Think Hard - Your 1 Day Loss Can Be </b><br>`;
    reportBody += `<b>Our Lifetime Subscription Charges</b> üíöüíö`;
          }

      /*reportBody += `‚û°Ô∏è‚û°Ô∏è <b>Final Result (Day Summary)</b><br>`;
      reportBody += `‚û°Ô∏è‚û°Ô∏è <b>Total Pips: ${totalPips.toFixed(1)}</b><br>`;
      reportBody += `üí≤ <b>Profit for 0.10 Lot: $${totalProfit01.toFixed(2)}</b>üí≤<br>`;
      reportBody += `üí≤ <b>Profit for 1 Lot: $${totalProfit1.toFixed(2)}</b></b><br><br>`;

      reportBody += `üî•üî•<b>Strong Start to December ‚Äî Consistent Profits!</b></b><br>`;
      reportBody += `üîó <b>Join us & grow your account daily!üí∞üöÄ</b></b><br>`;*/
    

    return reportBody;
}

function getRadioValue(name) {
  return document.querySelector(`input[name="${name}"]:checked`)?.value || "";
}

const digitEmoji = ["0Ô∏è‚É£","1Ô∏è‚É£","2Ô∏è‚É£","3Ô∏è‚É£","4Ô∏è‚É£","5Ô∏è‚É£","6Ô∏è‚É£","7Ô∏è‚É£","8Ô∏è‚É£","9Ô∏è‚É£"];

function toEmojiNumber(n){
  return String(n)
    .split("")
    .map(d => digitEmoji[d])
    .join("");
}

let reportIndianMarket = true;
/* Event Handler for Report Message Markert Type */
const marketRadios = document.querySelectorAll('input[name="markettype"]');
marketRadios.forEach(radio => {
  radio.addEventListener('change', function(event) {
    // The event.target is the specific radio button that was clicked
    const selectedValue = event.target.value;

    selectedValue === "FOREX"? reportIndianMarket=false : reportIndianMarket=true ;

    //console.log("Changed Value - ",selectedValue);
    refreshReportModal();
    // You would call your filtering function here:
    // filterTrades(selectedValue); 
  });
});

/* THIS FUNCTION IS CALLED WHEN THE USER CHANGES REPORT FOR MARKET TYPE */
function refreshReportModal()
{
  let reportMessage = "";
  reportMessage = generateReportShow(calls);
  //reportMessage = generateReportCopy(calls); //generateReportShow(calls);
  editableMessage.innerHTML = reportMessage;
}

function saveEditedMessage() {
  //copyAndOpenTelegram();
  copyToTelegram();  

  const box = document.getElementById("editableMessage");
  box.contentEditable = "false";
  box.classList.add("readonly");
}

async function copyToTelegram() {
    // 1. Get text from the div
    //const message = document.getElementById('editableMessage').innerText;
    const message = getTelegramSafeMessage();

    //const message = generateReportCopy(calls);
    //console.log(message);
    // 2. Comprehensive Copy Function (Works on HTTP & HTTPS)
    if (navigator.clipboard && window.isSecureContext) {
        // Modern approach for HTTPS/localhost
        await navigator.clipboard.writeText(message);
    } else {
        // Fallback approach for HTTP
        const textArea = document.createElement("textarea");
        textArea.value = message;
        
        // Ensure it's not visible but still in the DOM
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        textArea.style.top = "0";
        document.body.appendChild(textArea);
        
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Fallback copy failed', err);
        }
        
        document.body.removeChild(textArea);
    }

    // 3. Open Telegram Share Link (Handles emojis via encodeURIComponent)
    //const encodedMessage = encodeURIComponent(message);
    //const telegramUrl = `t.me{encodedMessage}`;
    //window.open(telegramUrl, '_blank');
}

function getTelegramSafeMessage() {
  let html = editableMessage.innerHTML;

  // Convert <br> to newline
  html = html.replace(/<br\s*\/?>/gi, '\n');

  // Convert bold tags
  html = html.replace(/<b>/gi, '**');
  html = html.replace(/<\/b>/gi, '**');

  // Remove ALL unsupported tags but keep text
  html = html.replace(/<\/?(div|p|span|font|section|article)[^>]*>/gi, '');

  // Remove ALL attributes
  html = html.replace(/<(\/?\w+)[^>]*>/g, '<$1>');

  // Allow only Telegram-supported tags
  html = html.replace(/<(?!\/?(b|strong|i|em|u|s|code|pre|a)\b)[^>]+>/gi, '');

  return html.trim();
}


function closeModal(id){document.getElementById(id).style.display='none'}

function intiApp(){
    loadScriptsJson();
    loadExpiryJson();
}

/* Load JSON Files */
intiApp();

</script>
</body>
</html>
